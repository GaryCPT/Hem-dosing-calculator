
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Hemlibra 劑量計算器</title>
</head>
<body>
    <h1>Hemlibra 劑量計算器</h1>
    
    <p><strong>步驟一：請勾選您院內可用的劑型（mg/支）</strong></p>
    <label><input type="checkbox" id="vial30" checked> 30 mg</label>
    <label><input type="checkbox" id="vial60" checked> 60 mg</label>

    <p><strong>步驟二：請輸入病人體重（公斤）</strong></p>
    <input type="number" id="weight" placeholder="例如：70" min="1" step="0.1">
    <button onclick="calculate()">計算劑量</button>

    <div id="result"></div>

    <script>
        function calculate() {
            const weight = parseFloat(document.getElementById("weight").value);
            const use30 = document.getElementById("vial30").checked;
            const use60 = document.getElementById("vial60").checked;

            if (isNaN(weight) || weight <= 0) {
                alert("請輸入有效的體重");
                return;
            }
            if (!use30 && !use60) {
                alert("請至少選擇一種可用劑型");
                return;
            }

            const loadingDose = 3 * weight;
            const maintenanceOptions = [
                { name: "每週", dose: 1.5 * weight },
                { name: "每兩週", dose: 3 * weight },
                { name: "每四週", dose: 6 * weight }
            ];

            const availableVials = [];
            if (use30) availableVials.push(30);
            if (use60) availableVials.push(60);
            availableVials.sort((a, b) => b - a);

            function getVialCombination(dose) {
                let remaining = dose;
                let vialCount = {};
                let totalDose = 0;
                for (let vial of availableVials) {
                    let count = Math.floor(remaining / vial);
                    if (count > 0) {
                        vialCount[vial] = count;
                        remaining -= count * vial;
                        totalDose += count * vial;
                    }
                }
                if (remaining > 0) {
                    const smallest = availableVials[availableVials.length - 1];
                    vialCount[smallest] = (vialCount[smallest] || 0) + 1;
                    totalDose += smallest;
                }
                return {
                    combination: vialCount,
                    totalDose: totalDose,
                    waste: totalDose - dose,
                    totalVials: Object.values(vialCount).reduce((a, b) => a + b, 0)
                };
            }

            function formatCombo(obj) {
                return Object.entries(obj).map(([mg, count]) => `${count} 瓶 × ${mg}mg`).join(" + ");
            }

            let html = `<h2>結果</h2>
                        <p><strong>體重：</strong> ${weight} kg</p>
                        <p><strong>選擇劑型：</strong> ${availableVials.join("mg, ")}mg</p>`;

            let loadingCombo = getVialCombination(loadingDose);
            html += `<h3>負荷期（每週3 mg/kg，連續4週）</h3>
                     <p>每週劑量：${loadingDose.toFixed(1)} mg</p>
                     <p>建議組合：${formatCombo(loadingCombo.combination)}</p>
                     <p>每週浪費：${loadingCombo.waste.toFixed(1)} mg</p>
                     <p><strong>四週總用量：</strong> ${loadingCombo.totalVials * 4} 瓶，<strong>總浪費：</strong> ${(loadingCombo.waste * 4).toFixed(1)} mg</p>`;

            html += `<h3>維持期劑量選項：</h3><ul>`;
            for (let opt of maintenanceOptions) {
                let combo = getVialCombination(opt.dose);
                html += `<li>${opt.name}：${opt.dose.toFixed(1)} mg →
                            ${formatCombo(combo.combination)}，浪費 ${combo.waste.toFixed(1)} mg，共 ${combo.totalVials} 瓶</li>`;
            }
            html += "</ul>";

            document.getElementById("result").innerHTML = html;
        }
    </script>
</body>
</html>
