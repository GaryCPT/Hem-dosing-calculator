<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>Hemlibra 劑量計算機</title>
  <style>
    /* ===== 色彩設計：白、藍、橘 ===== */
    :root {
      --main-bg: #ffffff;      /* 白色背景 */
      --main-blue: #0050B2;    /* 藍色 */
      --main-orange: #ff7000;  /* 橘色 */
      --text-color: #333333;   /* 文字顏色 */
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Helvetica Neue", Arial, sans-serif;
      background-color: var(--main-bg);
      color: var(--text-color);
    }

    /* ===== 頂部區域 (Header) ===== */
    header {
      background-color: var(--main-blue);
      color: #fff;
      padding: 20px;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.8em;
    }
    header p {
      margin: 5px 0 0;
      font-size: 1.0em;
    }

    /* ===== 主容器 ===== */
    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background-color: #fafafa;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    /* ===== 表單區塊 ===== */
    .form-section {
      margin-bottom: 20px;
      padding: 15px 20px;
      border: 2px solid var(--main-orange);
      border-radius: 8px;
      background-color: #fff;
    }
    .form-section h2 {
      color: var(--main-orange);
      margin-top: 0;
    }
    .form-group {
      margin-bottom: 12px;
    }
    label {
      display: inline-block;
      min-width: 120px;
      margin-bottom: 6px;
      vertical-align: middle;
      font-weight: 600;
    }
    select, input[type="number"] {
      width: 160px;
      padding: 6px 8px;
      margin-left: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.95em;
    }
    .radio-group {
      margin: 8px 0;
    }
    .radio-group label {
      font-weight: normal;
      margin-left: 5px;
    }

    /* ===== 按鈕設計 ===== */
    .calc-btn {
      background-color: var(--main-blue);
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 20px;
      font-size: 1em;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-top: 10px;
    }
    .calc-btn:hover {
      background-color: #003B85; /* 深一點的藍 */
    }

    /* ===== 結果區塊 ===== */
    .result-section {
      margin-top: 20px;
      padding: 15px;
      border: 2px solid var(--main-orange);
      border-radius: 8px;
      background: #ffffff;
    }
    .result-section h2 {
      margin-top: 0;
      color: var(--main-blue);
    }
    .result-section table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    .result-section th,
    .result-section td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      font-size: 0.95em;
    }
    .result-section th {
      background-color: #f5f5f5;
    }
    .note {
      font-size: 0.9em;
      color: #666;
      margin-top: 10px;
    }

    /* ===== RWD調整 ===== */
    @media (max-width: 600px) {
      .container {
        margin: 10px;
        padding: 10px;
      }
      label {
        display: block;
        margin-bottom: 4px;
      }
      select, input[type="number"] {
        width: 100%;
        margin: 0 0 10px 0;
      }
      .form-group {
        margin-bottom: 15px;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>Hemlibra 劑量計算機</h1>
  <p>依循健保規範，計算負荷期與維持期所需的最少瓶數</p>
</header>

<div class="container">
  <div class="form-section">
    <h2>輸入參數</h2>
    <div class="form-group">
      <label for="weight">病患體重(kg)</label>
      <input type="number" id="weight" min="1" step="0.1" value="75" />
    </div>

    <div class="form-group">
      <label>可用劑型</label>
      <div class="radio-group">
        <input type="radio" id="vial60" name="vial_option" value="60" checked />
        <label for="vial60">僅 60 mg/vial</label>

        <br/>

        <input type="radio" id="vial30" name="vial_option" value="30" />
        <label for="vial30">僅 30 mg/vial</label>

        <br/>

        <input type="radio" id="vialBoth" name="vial_option" value="both" />
        <label for="vialBoth">同時有 30 mg & 60 mg</label>
      </div>
    </div>

    <div class="form-group">
      <label for="frequency">維持期頻率</label>
      <select id="frequency">
        <option value="weekly">每週 (1.5 mg/kg)</option>
        <option value="q2w" selected>每兩週 (3 mg/kg)</option>
        <option value="q4w">每四週 (6 mg/kg)</option>
      </select>
    </div>

    <button class="calc-btn" onclick="calculate()">計 算</button>
  </div>

  <div id="result" class="result-section" style="display: none;">
    <h2>計算結果</h2>
    <div id="resultText"></div>
  </div>
</div>

<script>
/**
 * 回傳物件: 
 *  {
 *    totalMg: number,          // 該次實際可提供的 mg
 *    vialsUsed: number,        // 該次總瓶數
 *    detailText: string,       // 顯示文字(例如 "2瓶×60 + 1瓶×30 = 150 mg")
 *    wastedMg: number,         // 浪費 mg
 *    vialCount30: number,      // 30mg 瓶數
 *    vialCount60: number       // 60mg 瓶數
 *  }
 */
function findBestVialCombination(requiredMg, vialOption) {
  let possibleVialSizes = [];
  if (vialOption === '60') {
    possibleVialSizes = [60];
  } else if (vialOption === '30') {
    possibleVialSizes = [30];
  } else {
    possibleVialSizes = [30, 60];
  }

  // 單一規格
  if (possibleVialSizes.length === 1) {
    const size = possibleVialSizes[0];
    const count = Math.ceil(requiredMg / size);
    const totalMg = count * size;
    const wasted = totalMg - requiredMg;
    // 判斷是 30 還是 60
    return {
      totalMg: totalMg,
      vialsUsed: count,
      wastedMg: wasted,
      detailText: `${count} 瓶 × ${size} mg = ${totalMg} mg`,
      vialCount30: (size === 30) ? count : 0,
      vialCount60: (size === 60) ? count : 0
    };
  }

  // 同時有 30 和 60 -> 混搭
  let best = null;
  // 設計一個上限: 假設單次施打不會超過 20 瓶 (可依需求調大)
  for (let num30 = 0; num30 <= 20; num30++) {
    for (let num60 = 0; num60 <= 20; num60++) {
      const totalMg = (num30 * 30) + (num60 * 60);
      if (totalMg < requiredMg) continue; // 不足就跳過

      const wasted = totalMg - requiredMg;
      const totalVials = num30 + num60;

      if (!best) {
        best = { totalMg, wasted, totalVials, num30, num60 };
      } else {
        // 比較：先比浪費 mg（小者優先），同浪費再比總瓶數（小者優先）
        if (wasted < best.wasted) {
          best = { totalMg, wasted, totalVials, num30, num60 };
        } else if (wasted === best.wasted && totalVials < best.totalVials) {
          best = { totalMg, wasted, totalVials, num30, num60 };
        }
      }
    }
  }

  if (!best) {
    // 理論上不太會發生
    return {
      totalMg: 0,
      vialsUsed: 0,
      wastedMg: 0,
      detailText: '找不到足量組合',
      vialCount30: 0,
      vialCount60: 0
    };
  }

  const detailParts = [];
  if (best.num60 > 0) detailParts.push(`${best.num60} 瓶 × 60 mg`);
  if (best.num30 > 0) detailParts.push(`${best.num30} 瓶 × 30 mg`);
  const detailStr = detailParts.join(' + ') + ` = ${best.totalMg} mg`;

  return {
    totalMg: best.totalMg,
    vialsUsed: best.totalVials,
    wastedMg: best.wasted,
    detailText: detailStr,
    vialCount30: best.num30,
    vialCount60: best.num60
  };
}

function calculate() {
  // 1. 讀取輸入
  const weight = parseFloat(document.getElementById('weight').value) || 0;
  if (weight <= 0) {
    alert('請輸入正確的體重數值!');
    return;
  }
  const vialOption = document.querySelector('input[name="vial_option"]:checked').value;
  const frequency = document.getElementById('frequency').value;

  // 2. 計算「負荷期」參數
  // 負荷期：每週 3 mg/kg，連續4週
  const loadingDoseEach = 3 * weight;
  const loadingTimes = 4;

  // 3. 計算「維持期」參數
  let maintenanceDoseEach = 0;
  let maintenanceTimes = 0;
  let freqText = '';

  switch(frequency) {
    case 'weekly': // 每週 1.5 mg/kg
      maintenanceDoseEach = 1.5 * weight;
      maintenanceTimes = 52;
      freqText = '每週 (1.5 mg/kg)';
      break;
    case 'q2w': // 每兩週 3 mg/kg
      maintenanceDoseEach = 3 * weight;
      maintenanceTimes = 26;
      freqText = '每兩週 (3 mg/kg)';
      break;
    case 'q4w': // 每四週 6 mg/kg
      maintenanceDoseEach = 6 * weight;
      maintenanceTimes = 13;
      freqText = '每四週 (6 mg/kg)';
      break;
  }

  // 4. 負荷期計算：總瓶數、30 mg 總瓶數、60 mg 總瓶數
  let loadingTotalVials = 0;
  let loadingTotal30 = 0;
  let loadingTotal60 = 0;
  let loadingTotalProvidedMg = 0;

  for (let i = 0; i < loadingTimes; i++) {
    const combo = findBestVialCombination(loadingDoseEach, vialOption);
    loadingTotalVials += combo.vialsUsed;
    loadingTotal30 += combo.vialCount30;
    loadingTotal60 += combo.vialCount60;
    loadingTotalProvidedMg += combo.totalMg;
  }

  // 5. 維持期計算
  let maintenanceTotalVials = 0;
  let maintenanceTotal30 = 0;
  let maintenanceTotal60 = 0;
  let maintenanceTotalProvidedMg = 0;

  for (let i = 0; i < maintenanceTimes; i++) {
    const combo = findBestVialCombination(maintenanceDoseEach, vialOption);
    maintenanceTotalVials += combo.vialsUsed;
    maintenanceTotal30 += combo.vialCount30;
    maintenanceTotal60 += combo.vialCount60;
    maintenanceTotalProvidedMg += combo.totalMg;
  }

  // 6. 全年合計
  const totalVials = loadingTotalVials + maintenanceTotalVials;
  const total30 = loadingTotal30 + maintenanceTotal30;
  const total60 = loadingTotal60 + maintenanceTotal60;
  const totalProvidedMg = loadingTotalProvidedMg + maintenanceTotalProvidedMg;
  const realNeeded = (loadingDoseEach * loadingTimes) + (maintenanceDoseEach * maintenanceTimes);
  const totalWasted = totalProvidedMg - realNeeded;

  // 7. 組合輸出
  const resultContainer = document.getElementById('resultText');
  document.getElementById('result').style.display = 'block';

  const html = `
    <!-- 基本條件 -->
    <table>
      <tr><th colspan="2">基本條件</th></tr>
      <tr>
        <td>病患體重</td>
        <td>${weight.toFixed(1)} kg</td>
      </tr>
      <tr>
        <td>可用劑型</td>
        <td>${
          (vialOption === '60') ? '僅 60 mg/vial' :
          (vialOption === '30') ? '僅 30 mg/vial' : 
          '30 mg & 60 mg 均可'
        }</td>
      </tr>
      <tr>
        <td>維持期頻率</td>
        <td>${freqText}</td>
      </tr>
    </table>

    <!-- 負荷期 -->
    <table>
      <tr><th colspan="6">負荷期 (Loading)：前 4 週，每週 3 mg/kg</th></tr>
      <tr>
        <td>單次需求 (mg)</td>
        <td>合計需求 (mg)</td>
        <td>負荷期合計 總瓶數</td>
        <td>30 mg 總瓶數</td>
        <td>60 mg 總瓶數</td>
        <td>實際供給 (mg)</td>
      </tr>
      <tr>
        <td>${loadingDoseEach.toFixed(1)}</td>
        <td>${(loadingDoseEach * loadingTimes).toFixed(1)}</td>
        <td>${loadingTotalVials}</td>
        <td>${loadingTotal30}</td>
        <td>${loadingTotal60}</td>
        <td>${loadingTotalProvidedMg}</td>
      </tr>
    </table>

    <!-- 維持期 -->
    <table>
      <tr><th colspan="6">維持期 (Maintenance)</th></tr>
      <tr>
        <td>單次需求 (mg)</td>
        <td>一年次數</td>
        <td>合計需求 (mg/年)</td>
        <td>維持期合計 總瓶數</td>
        <td>30 mg 總瓶數</td>
        <td>60 mg 總瓶數</td>
      </tr>
      <tr>
        <td>${maintenanceDoseEach.toFixed(1)}</td>
        <td>${maintenanceTimes}</td>
        <td>${(maintenanceDoseEach * maintenanceTimes).toFixed(1)}</td>
        <td>${maintenanceTotalVials}</td>
        <td>${maintenanceTotal30}</td>
        <td>${maintenanceTotal60}</td>
      </tr>
    </table>

    <!-- 一年合計 -->
    <table>
      <tr><th colspan="6">一年合計</th></tr>
      <tr>
        <td>總需求量 (mg)</td>
        <td>實際供給 (mg)</td>
        <td>浪費量 (mg)</td>
        <td>總瓶數</td>
        <td>30 mg 總瓶數</td>
        <td>60 mg 總瓶數</td>
      </tr>
      <tr>
        <td>${realNeeded.toFixed(1)}</td>
        <td>${totalProvidedMg}</td>
        <td>${totalWasted}</td>
        <td>${totalVials}</td>
        <td>${total30}</td>
        <td>${total60}</td>
      </tr>
    </table>

    <div class="note">
      <strong>注意：</strong>此計算假設開瓶後的剩餘藥量無法跨次再使用，共用。若院內可實施特殊作業方式(如同一病人同日分次注射、或多人共用)，結果可能不同。
    </div>
  `;

  resultContainer.innerHTML = html;
}
</script>

</body>
</html>