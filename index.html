<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>Hemlibra åŠ‘é‡è¨ˆç®—æ©Ÿ</title>
  <style>
    /* ===== è‰²å½©è¨­è¨ˆï¼šç™½ã€è—ã€æ©˜ï¼ŒåŠ å¼·æŸ”å’Œåº¦ & æ”¾å¤§å­—é«” ===== */
    :root {
      --main-bg: #ffffff;      /* ç™½è‰²èƒŒæ™¯ */
      --main-blue: #0050B2;    /* è—è‰² */
      --main-orange: #ff7000;  /* æ©˜è‰² */
      --text-color: #333333;   /* æ–‡å­—é¡è‰² */
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Microsoft JhengHei", "Helvetica Neue", Arial, sans-serif;
      /* æ•´é«”æ”¾å¤§å­—é«” */
      font-size: 18px;
      background-color: var(--main-bg);
      color: var(--text-color);
    }

    /* ===== é ‚éƒ¨å€åŸŸ (Header) ===== */
    header {
      background-color: var(--main-blue);
      color: #fff;
      padding: 20px;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.8em;
    }
    header p {
      margin: 6px 0 0;
      font-size: 1.0em;
    }

    /* ===== ä¸»å®¹å™¨ ===== */
    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background-color: #fefefe;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    /* ===== è¡¨å–®å€å¡Š ===== */
    .form-section {
      margin-bottom: 20px;
      padding: 15px 20px;
      border: 2px solid var(--main-orange);
      border-radius: 10px;
      background-color: #fff;
    }
    .form-section h2 {
      color: var(--main-orange);
      margin-top: 0;
      font-size: 1.3em;
    }
    .form-group {
      margin-bottom: 14px;
    }
    label {
      display: inline-block;
      min-width: 120px;
      margin-bottom: 6px;
      vertical-align: middle;
      font-weight: 600;
    }
    select, input[type="number"] {
      width: 160px;
      padding: 6px 8px;
      margin-left: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.95em;
    }
    .radio-group {
      margin: 8px 0;
    }
    .radio-group label {
      font-weight: normal;
      margin-left: 5px;
    }

    /* ===== æŒ‰éˆ•è¨­è¨ˆ ===== */
    .calc-btn, .copy-btn {
      background-color: var(--main-blue);
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 20px;
      font-size: 1em;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-top: 10px;
      margin-right: 10px;
      outline: none;
    }
    .calc-btn:hover, .copy-btn:hover {
      background-color: #003B85; /* æ·±ä¸€é»çš„è— */
    }

    /* ===== çµæœå€å¡Š ===== */
    .result-section {
      margin-top: 20px;
      padding: 15px;
      border: 2px solid var(--main-orange);
      border-radius: 10px;
      background: #ffffff;
    }
    .result-section h2 {
      margin-top: 0;
      color: var(--main-blue);
      font-size: 1.3em;
    }
    .result-section table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    .result-section th,
    .result-section td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      font-size: 0.95em;
    }
    .result-section th {
      background-color: #f5f5f5;
    }
    .note {
      font-size: 0.9em;
      color: #666;
      margin-top: 10px;
      line-height: 1.4;
    }

    /* ===== RWDèª¿æ•´ ===== */
    @media (max-width: 600px) {
      .container {
        margin: 10px;
        padding: 10px;
      }
      label {
        display: block;
        margin-bottom: 4px;
      }
      select, input[type="number"] {
        width: 100%;
        margin: 0 0 10px 0;
      }
      .form-group {
        margin-bottom: 15px;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>Hemlibra åŠ‘é‡è¨ˆç®—æ©Ÿ</h1>
  <p>ä¾å¾ªå¥ä¿è¦ç¯„ï¼Œè¨ˆç®—è² è·æœŸèˆ‡ç¶­æŒæœŸæ‰€éœ€çš„æœ€å°ç“¶æ•¸</p>
</header>

<div class="container">
  <div class="form-section">
    <h2>è¼¸å…¥åƒæ•¸</h2>
    <div class="form-group">
      <label for="weight">ç—…æ‚£é«”é‡(kg)</label>
      <input type="number" id="weight" min="1" step="0.1" value="75" />
    </div>

    <div class="form-group">
      <label>å¯ç”¨åŠ‘å‹</label>
      <div class="radio-group">
        <input type="radio" id="vial60" name="vial_option" value="60" checked />
        <label for="vial60">åƒ… 60 mg/vial</label>
        <br/>
        <input type="radio" id="vial30" name="vial_option" value="30" />
        <label for="vial30">åƒ… 30 mg/vial</label>
        <br/>
        <input type="radio" id="vialBoth" name="vial_option" value="both" />
        <label for="vialBoth">åŒæ™‚æœ‰ 30 mg & 60 mg</label>
      </div>
    </div>

    <div class="form-group">
      <label for="frequency">ç¶­æŒæœŸé »ç‡</label>
      <select id="frequency">
        <option value="weekly">æ¯é€± (1.5 mg/kg)</option>
        <option value="q2w" selected>æ¯å…©é€± (3 mg/kg)</option>
        <option value="q4w">æ¯å››é€± (6 mg/kg)</option>
      </select>
    </div>

    <button class="calc-btn" onclick="calculate()">è¨ˆ ç®—</button>
  </div>

  <div id="result" class="result-section" style="display: none;">
    <h2>è¨ˆç®—çµæœ</h2>
    <div id="resultText"></div>

    <!-- è¤‡è£½ç”¨æŒ‰éˆ• -->
    <button class="copy-btn" onclick="copyDoseInfo()">è¤‡è£½ä½¿ç”¨åŠ‘é‡</button>
  </div>
</div>

<script>
/**
 * findBestVialCombination():
 *   çµ¦å®šå–®æ¬¡éœ€æ±‚ mg, èˆ‡å¯ç”¨åŠ‘å‹('60'|'30'|'both'),
 *   å›å‚³åŒ…å«æ­¤ç¨®æ–½æ‰“æ‰€éœ€çš„ 30 mg ç“¶æ•¸ã€60 mg ç“¶æ•¸ã€ä»¥åŠæµªè²»è³‡è¨Šç­‰ã€‚
 *
 * å›å‚³ç‰©ä»¶æ ¼å¼: 
 *  {
 *    totalMg: number,          // è©²æ¬¡å¯¦éš›å¯æä¾›çš„ mg
 *    vialsUsed: number,        // è©²æ¬¡ç¸½ç“¶æ•¸ (30+60åˆè¨ˆ)
 *    wastedMg: number,         // æµªè²» mg
 *    vialCount30: number,      // 30 mg ç“¶æ•¸
 *    vialCount60: number       // 60 mg ç“¶æ•¸
 *  }
 */
function findBestVialCombination(requiredMg, vialOption) {
  let possibleVialSizes = [];
  if (vialOption === '60') {
    possibleVialSizes = [60];
  } else if (vialOption === '30') {
    possibleVialSizes = [30];
  } else {
    // both
    possibleVialSizes = [30, 60];
  }

  // åªæœ‰å–®ä¸€è¦æ ¼
  if (possibleVialSizes.length === 1) {
    const size = possibleVialSizes[0];
    const count = Math.ceil(requiredMg / size);
    return {
      totalMg: count * size,
      vialsUsed: count,
      wastedMg: (count * size) - requiredMg,
      vialCount30: (size === 30 ? count : 0),
      vialCount60: (size === 60 ? count : 0)
    };
  }

  // åŒæ™‚æœ‰ 30 + 60 mg
  let best = null;
  for (let num30 = 0; num30 <= 20; num30++) {
    for (let num60 = 0; num60 <= 20; num60++) {
      const totalMg = (num30 * 30) + (num60 * 60);
      if (totalMg < requiredMg) continue; // ä¸è¶³å°±è·³é

      const wasted = totalMg - requiredMg;
      const totalVials = num30 + num60;

      if (!best) {
        best = { totalMg, wasted, totalVials, num30, num60 };
      } else {
        // å„ªå…ˆæµªè²»æœ€å°‘ï¼Œè‹¥æµªè²»ç›¸åŒå‰‡ç“¶æ•¸æœ€å°‘
        if (wasted < best.wasted) {
          best = { totalMg, wasted, totalVials, num30, num60 };
        } else if (wasted === best.wasted && totalVials < best.totalVials) {
          best = { totalMg, wasted, totalVials, num30, num60 };
        }
      }
    }
  }

  if (!best) {
    // ç†è«–ä¸Šä¸å¤ªæœƒç™¼ç”Ÿ
    return {
      totalMg: 0,
      vialsUsed: 0,
      wastedMg: 0,
      vialCount30: 0,
      vialCount60: 0
    };
  }

  return {
    totalMg: best.totalMg,
    vialsUsed: best.totalVials,
    wastedMg: best.wasted,
    vialCount30: best.num30,
    vialCount60: best.num60
  };
}

/* å…¨åŸŸè®Šæ•¸ï¼Œç”¨ä¾†åœ¨è¨ˆç®—å®Œæˆå¾Œå„²å­˜å¿…è¦è³‡è¨Šï¼Œä¾› "è¤‡è£½ä½¿ç”¨åŠ‘é‡" åŠŸèƒ½ä½¿ç”¨ */
let finalData = {
  weight: 0,
  vialOption: '',
  frequency: '',
  loadingTotal30: 0,
  loadingTotal60: 0,
  maintenanceTotal30: 0,
  maintenanceTotal60: 0,
  total30: 0,
  total60: 0
};

function calculate() {
  // 1. å–å¾—ä½¿ç”¨è€…è¼¸å…¥
  const weight = parseFloat(document.getElementById('weight').value) || 0;
  if (weight <= 0) {
    alert('è«‹è¼¸å…¥æ­£ç¢ºçš„é«”é‡æ•¸å€¼!');
    return;
  }
  const vialOption = document.querySelector('input[name="vial_option"]:checked').value;
  const frequency = document.getElementById('frequency').value;

  // 2. è² è·æœŸ (Loading) -> æ¯é€± 3 mg/kgï¼Œé€£çºŒ 4 é€±
  const loadingDoseEach = 3 * weight;
  const loadingTimes = 4;

  // 3. ç¶­æŒæœŸ (Maintenance)
  let maintenanceDoseEach = 0;
  let maintenanceTimes = 0;
  let freqText = '';

  switch(frequency) {
    case 'weekly': // æ¯é€±
      maintenanceDoseEach = 1.5 * weight;
      maintenanceTimes = 52;
      freqText = 'æ¯é€± (1.5 mg/kg)';
      break;
    case 'q2w': // æ¯å…©é€±
      maintenanceDoseEach = 3 * weight;
      maintenanceTimes = 26;
      freqText = 'æ¯å…©é€± (3 mg/kg)';
      break;
    case 'q4w': // æ¯å››é€±
      maintenanceDoseEach = 6 * weight;
      maintenanceTimes = 13;
      freqText = 'æ¯å››é€± (6 mg/kg)';
      break;
  }

  // 4. è¨ˆç®—è² è·æœŸ
  let loadingTotal30 = 0;
  let loadingTotal60 = 0;
  let loadingProvidedMg = 0;

  for (let i = 0; i < loadingTimes; i++) {
    const combo = findBestVialCombination(loadingDoseEach, vialOption);
    loadingTotal30 += combo.vialCount30;
    loadingTotal60 += combo.vialCount60;
    loadingProvidedMg += combo.totalMg;
  }

  // 5. è¨ˆç®—ç¶­æŒæœŸ
  let maintenanceTotal30 = 0;
  let maintenanceTotal60 = 0;
  let maintenanceProvidedMg = 0;

  for (let i = 0; i < maintenanceTimes; i++) {
    const combo = findBestVialCombination(maintenanceDoseEach, vialOption);
    maintenanceTotal30 += combo.vialCount30;
    maintenanceTotal60 += combo.vialCount60;
    maintenanceProvidedMg += combo.totalMg;
  }

  // 6. å¹´åº¦åˆè¨ˆ
  const total30 = loadingTotal30 + maintenanceTotal30;
  const total60 = loadingTotal60 + maintenanceTotal60;
  const totalProvidedMg = loadingProvidedMg + maintenanceProvidedMg;
  const realNeeded = (loadingDoseEach * loadingTimes) + (maintenanceDoseEach * maintenanceTimes);
  const totalWasted = totalProvidedMg - realNeeded;

  // 7. æ›´æ–°å…¨åŸŸè®Šæ•¸ (ä¾›è¤‡è£½åŠŸèƒ½)
  finalData = {
    weight,
    vialOption,
    frequency: freqText,
    loadingTotal30,
    loadingTotal60,
    maintenanceTotal30,
    maintenanceTotal60,
    total30,
    total60
  };

  // 8. å°‡çµæœé¡¯ç¤ºåœ¨ç•«é¢ä¸Š (åªé¡¯ç¤º 30mg(ğŸ’‰) èˆ‡ 60mg(ğŸ’‰)ï¼Œä¸å†é¡¯ç¤ºã€Œç¸½ç“¶æ•¸ã€)
  document.getElementById('result').style.display = 'block';
  const resultContainer = document.getElementById('resultText');

  const vialOptionText = (
    (vialOption === '60') ? 'åƒ… 60 mg/vial' :
    (vialOption === '30') ? 'åƒ… 30 mg/vial' : 
    '30 mg & 60 mg å‡å¯'
  );

  const html = `
    <!-- åŸºæœ¬æ¢ä»¶ -->
    <table>
      <tr><th colspan="2">åŸºæœ¬æ¢ä»¶</th></tr>
      <tr>
        <td>ç—…æ‚£é«”é‡</td>
        <td>${weight.toFixed(1)} kg</td>
      </tr>
      <tr>
        <td>å¯ç”¨åŠ‘å‹</td>
        <td>${vialOptionText}</td>
      </tr>
      <tr>
        <td>ç¶­æŒæœŸé »ç‡</td>
        <td>${freqText}</td>
      </tr>
    </table>

    <!-- è² è·æœŸ -->
    <table>
      <tr><th colspan="5">è² è·æœŸ (Loading)ï¼šå‰ 4 é€±ï¼Œæ¯é€± 3 mg/kg</th></tr>
      <tr>
        <th>å–®æ¬¡éœ€æ±‚ (mg)</th>
        <th>åˆè¨ˆéœ€æ±‚ (mg)</th>
        <th>30 mg(ğŸ’‰)</th>
        <th>60 mg(ğŸ’‰)</th>
        <th>å¯¦éš›ä¾›çµ¦ (mg)</th>
      </tr>
      <tr>
        <td>${loadingDoseEach.toFixed(1)}</td>
        <td>${(loadingDoseEach * loadingTimes).toFixed(1)}</td>
        <td>${loadingTotal30}</td>
        <td>${loadingTotal60}</td>
        <td>${loadingProvidedMg}</td>
      </tr>
    </table>

    <!-- ç¶­æŒæœŸ -->
    <table>
      <tr><th colspan="5">ç¶­æŒæœŸ (Maintenance)</th></tr>
      <tr>
        <th>å–®æ¬¡éœ€æ±‚ (mg)</th>
        <th>ä¸€å¹´æ¬¡æ•¸</th>
        <th>30 mg(ğŸ’‰)</th>
        <th>60 mg(ğŸ’‰)</th>
        <th>å¯¦éš›ä¾›çµ¦ (mg)</th>
      </tr>
      <tr>
        <td>${maintenanceDoseEach.toFixed(1)}</td>
        <td>${maintenanceTimes}</td>
        <td>${maintenanceTotal30}</td>
        <td>${maintenanceTotal60}</td>
        <td>${maintenanceProvidedMg}</td>
      </tr>
    </table>

    <!-- ä¸€å¹´åˆè¨ˆ -->
    <table>
      <tr><th colspan="5">ä¸€å¹´åˆè¨ˆ</th></tr>
      <tr>
        <th>ç¸½éœ€æ±‚é‡ (mg)</th>
        <th>å¯¦éš›ä¾›çµ¦ (mg)</th>
        <th>æµªè²»é‡ (mg)</th>
        <th>30 mg(ğŸ’‰)</th>
        <th>60 mg(ğŸ’‰)</th>
      </tr>
      <tr>
        <td>${realNeeded.toFixed(1)}</td>
        <td>${totalProvidedMg}</td>
        <td>${totalWasted}</td>
        <td>${total30}</td>
        <td>${total60}</td>
      </tr>
    </table>

    <div class="note">
      <strong>æ³¨æ„ï¼š</strong>æ­¤è¨ˆç®—å‡è¨­ã€Œæ¯æ¬¡é–‹ç“¶å¾Œçš„å‰©é¤˜è—¥é‡ç„¡æ³•è·¨æ¬¡å†ä½¿ç”¨ã€ã€‚è‹¥é™¢å…§å¯¦éš›ä½œæ¥­å¯å…±ç”¨æœªä½¿ç”¨å®Œè—¥é‡ï¼Œçµæœå¯å†èª¿æ•´ã€‚
    </div>
  `;

  resultContainer.innerHTML = html;
}

/**
 * copyDoseInfo():
 *   å°‡ finalData ä¸­çš„è³‡è¨Šæ•´ç†æˆæ–‡å­—å¾Œè¤‡è£½åˆ°å‰ªè²¼ç°¿
 *   åªé¡¯ç¤ºã€Œæœ‰ç”¨åˆ°çš„åŠ‘å‹ã€ï¼ˆå¦‚æœå°æ‡‰çš„ç“¶æ•¸ç‚º0å°±ä¸é¡¯ç¤ºï¼‰
 */
function copyDoseInfo() {
  const d = finalData;

  // (1) æ‚£è€…é«”é‡
  let lines = [];
  lines.push(`(1) æ‚£è€…é«”é‡: ${d.weight} kg`);

  // (2) é†«é™¢æœ‰çš„åŠ‘å‹
  let optionText = '';
  if (d.vialOption === '60') optionText = 'åƒ… 60 mg/vial';
  else if (d.vialOption === '30') optionText = 'åƒ… 30 mg/vial';
  else optionText = '30 mg & 60 mg å‡å¯';
  lines.push(`(2) é†«é™¢æœ‰çš„åŠ‘å‹: ${optionText}`);

  // (3) Loading phase
  let loadingLine = '(3) Loading Phase: ';
  let tempArrL = [];
  if (d.loadingTotal30 > 0) tempArrL.push(`${d.loadingTotal30} ç“¶ 30mg`);
  if (d.loadingTotal60 > 0) tempArrL.push(`${d.loadingTotal60} ç“¶ 60mg`);
  if (tempArrL.length === 0) {
    // ä»£è¡¨éƒ½æ²’ç”¨åˆ°, ä¾‹å¦‚åªæœ‰ 0ç“¶
    loadingLine += 'ç„¡';
  } else {
    loadingLine += tempArrL.join(' + ');
  }
  lines.push(loadingLine);

  // (4) Maintenance phase
  let maintenanceLine = '(4) Maintenance Phase: ';
  let tempArrM = [];
  if (d.maintenanceTotal30 > 0) tempArrM.push(`${d.maintenanceTotal30} ç“¶ 30mg`);
  if (d.maintenanceTotal60 > 0) tempArrM.push(`${d.maintenanceTotal60} ç“¶ 60mg`);
  if (tempArrM.length === 0) {
    maintenanceLine += 'ç„¡';
  } else {
    maintenanceLine += tempArrM.join(' + ');
  }
  lines.push(maintenanceLine);

  // (5) å¹´åº¦ç¸½é‡
  let totalLine = '(5) ç¸½å¹´åº¦ç”³è«‹é‡: ';
  let tempArrT = [];
  if (d.total30 > 0) tempArrT.push(`${d.total30} ç“¶ 30mg`);
  if (d.total60 > 0) tempArrT.push(`${d.total60} ç“¶ 60mg`);
  if (tempArrT.length === 0) {
    totalLine += 'ç„¡';
  } else {
    totalLine += tempArrT.join(' + ');
  }
  lines.push(totalLine);

  const copyText = lines.join('\n');

  // è¤‡è£½åˆ°å‰ªè²¼ç°¿
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(copyText).then(() => {
      alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿!');
    }).catch(err => {
      console.error('è¤‡è£½å¤±æ•—: ', err);
      alert('ç„¡æ³•ä½¿ç”¨è‡ªå‹•è¤‡è£½åŠŸèƒ½ï¼Œè«‹æ‰‹å‹•è¤‡è£½');
    });
  } else {
    // è‹¥ç€è¦½å™¨ä¸æ”¯æ´ clipboard API
    manualCopyFallback(copyText);
  }
}

/** è‹¥ç€è¦½å™¨ä¸æ”¯æ´ clipboard APIï¼Œå˜—è©¦ä»¥ textarea æ–¹æ¡ˆæ‰‹å‹•è¤‡è£½ */
function manualCopyFallback(text) {
  const textArea = document.createElement("textarea");
  textArea.value = text;
  // ä½¿ textArea ä¸åœ¨ viewport å¾è€Œä¸å½±éŸ¿ä½¿ç”¨è€…æ“ä½œ
  textArea.style.position = "fixed";
  textArea.style.left = "-99999px";
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  try {
    const successful = document.execCommand('copy');
    if (successful) {
      alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿!');
    } else {
      alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—è¤‡è£½ã€‚');
    }
  } catch (err) {
    alert('è¤‡è£½åŠŸèƒ½ä¸æ”¯æ´ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—è¤‡è£½ã€‚');
  }
  document.body.removeChild(textArea);
}
</script>

</body>
</html>