<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>Hemlibra 劑量計算工具</title>
  <style>
    body {
      max-width: 800px;
      margin: 0 auto;
      font-family: Arial, sans-serif;
      line-height: 1.5;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
    }
    .form-section {
      margin-bottom: 20px;
      padding: 10px 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    label {
      display: inline-block;
      width: 120px;
      margin-bottom: 8px;
      vertical-align: top;
    }
    select, input[type="number"] {
      width: 150px;
      padding: 5px;
      margin-bottom: 8px;
    }
    .radio-group {
      margin: 8px 0;
    }
    button {
      padding: 8px 16px;
      font-size: 16px;
      cursor: pointer;
    }
    .result-section {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #999;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .result-section table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .result-section th,
    .result-section td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    .note {
      font-size: 0.9em;
      color: #666;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<h1>Hemlibra 劑量計算工具</h1>
<p style="text-align:center;">
  根據健保規範，計算負荷期與維持期所需瓶數並盡量減少浪費。
</p>

<div class="form-section">
  <h2>基本資訊輸入</h2>
  <div>
    <label for="weight">病患體重(kg)</label>
    <input type="number" id="weight" min="1" step="0.1" value="75" />
  </div>

  <div>
    <label>可用劑型</label>
    <div class="radio-group">
      <input type="radio" id="vial60" name="vial_option" value="60" checked />
      <label for="vial60">僅 60 mg/vial</label><br />
      
      <input type="radio" id="vial30" name="vial_option" value="30" />
      <label for="vial30">僅 30 mg/vial</label><br />

      <input type="radio" id="vialBoth" name="vial_option" value="both" />
      <label for="vialBoth">同時有 30 mg & 60 mg</label>
    </div>
  </div>

  <div>
    <label for="frequency">維持期頻率</label>
    <select id="frequency">
      <option value="weekly">每週 (1.5 mg/kg)</option>
      <option value="q2w" selected>每兩週 (3 mg/kg)</option>
      <option value="q4w">每四週 (6 mg/kg)</option>
    </select>
  </div>

  <button onclick="calculate()">計 算</button>
</div>

<div id="result" class="result-section" style="display: none;">
  <h2>計算結果</h2>
  <div id="resultText"></div>
</div>

<script>
/**
 * 嘗試在給定可用劑型(30/60/both)的情況下，找出「最少瓶數」且「提供 mg >= 需求 mg」的最佳組合
 * @param {number} requiredMg - 單次需求 mg
 * @param {string} vialOption - '60' | '30' | 'both'
 * @returns {object} { totalMg, vialsUsed, detailText, wastedMg }
 */
function findBestVialCombination(requiredMg, vialOption) {
  let possibleVialSizes = [];
  if (vialOption === '60') {
    possibleVialSizes = [60];
  } else if (vialOption === '30') {
    possibleVialSizes = [30];
  } else {
    // both
    possibleVialSizes = [30, 60];
  }

  // 如果只有單一規格，就直接用數量上取整 (Math.ceil)
  if (possibleVialSizes.length === 1) {
    const size = possibleVialSizes[0];
    const count = Math.ceil(requiredMg / size);
    return {
      totalMg: count * size,
      vialsUsed: count,
      detailText: `${count} 瓶 × ${size} mg = ${count * size} mg`,
      wastedMg: (count * size) - requiredMg
    };
  }

  // 如果同時有 30 mg + 60 mg，嘗試在合ReasonableRange(這裡設0~20)的所有組合中找到浪費最少、瓶數最少的方案
  let best = null;

  for (let num30 = 0; num30 <= 20; num30++) {
    for (let num60 = 0; num60 <= 20; num60++) {
      const totalMg = (num30 * 30) + (num60 * 60);
      // 若不足需求 mg，跳過
      if (totalMg < requiredMg) continue;

      const totalVials = num30 + num60;
      const wasted = totalMg - requiredMg;

      if (best === null) {
        best = { totalMg, totalVials, num30, num60, wasted };
      } else {
        // 比較：先比浪費 mg（越少越好），若浪費相同再比總瓶數（越少越好）
        if (wasted < best.wasted) {
          best = { totalMg, totalVials, num30, num60, wasted };
        } else if (wasted === best.wasted && totalVials < best.totalVials) {
          best = { totalMg, totalVials, num30, num60, wasted };
        }
      }
    }
  }

  if (!best) {
    return {
      totalMg: 0,
      vialsUsed: 0,
      detailText: '找不到足量組合',
      wastedMg: 0
    };
  }

  const detailParts = [];
  if (best.num60 > 0) detailParts.push(`${best.num60} 瓶 × 60 mg`);
  if (best.num30 > 0) detailParts.push(`${best.num30} 瓶 × 30 mg`);

  return {
    totalMg: best.totalMg,
    vialsUsed: best.totalVials,
    detailText: detailParts.join(' + ') + ` = ${best.totalMg} mg`,
    wastedMg: best.wasted
  };
}

/**
 * 主計算流程
 */
function calculate() {
  // 1. 取得使用者輸入
  const weight = parseFloat(document.getElementById('weight').value) || 0;
  if (weight <= 0) {
    alert('請輸入正確的體重數值');
    return;
  }
  const vialOption = document.querySelector('input[name="vial_option"]:checked').value;
  const frequency = document.getElementById('frequency').value;

  // 2. 計算負荷期 (Loading)
  // 每週 3 mg/kg，連續 4 週
  const loadingDoseEach = 3 * weight;  // mg/次
  const loadingTimes = 4;             // 4週

  // 3. 維持期 (Maintenance)
  let maintenanceDoseEach = 0;
  let maintenanceTimes = 0;
  let freqText = '';
  
  switch(frequency) {
    case 'weekly': // 每週 1.5 mg/kg
      maintenanceDoseEach = 1.5 * weight;
      maintenanceTimes = 52;
      freqText = '每週 (1.5 mg/kg)';
      break;
    case 'q2w': // 每兩週 3 mg/kg
      maintenanceDoseEach = 3 * weight;
      maintenanceTimes = 26;
      freqText = '每兩週 (3 mg/kg)';
      break;
    case 'q4w': // 每四週 6 mg/kg
      maintenanceDoseEach = 6 * weight;
      maintenanceTimes = 13;
      freqText = '每四週 (6 mg/kg)';
      break;
  }

  // 4. 逐次計算「負荷期」的瓶數
  let loadingTotalVials = 0;
  let loadingTotalProvidedMg = 0;
  for (let i = 0; i < loadingTimes; i++) {
    const combo = findBestVialCombination(loadingDoseEach, vialOption);
    loadingTotalVials += combo.vialsUsed;
    loadingTotalProvidedMg += combo.totalMg;
  }

  // 5. 逐次計算「維持期」的瓶數 (一年)
  let maintenanceTotalVials = 0;
  let maintenanceTotalProvidedMg = 0;
  for (let i = 0; i < maintenanceTimes; i++) {
    const combo = findBestVialCombination(maintenanceDoseEach, vialOption);
    maintenanceTotalVials += combo.vialsUsed;
    maintenanceTotalProvidedMg += combo.totalMg;
  }

  // 6. 總結
  const totalVials = loadingTotalVials + maintenanceTotalVials;
  const totalProvidedMg = loadingTotalProvidedMg + maintenanceTotalProvidedMg;
  const realNeeded = (loadingDoseEach * loadingTimes) + (maintenanceDoseEach * maintenanceTimes);
  const totalWasted = totalProvidedMg - realNeeded;

  // 7. 組合輸出
  let html = `
    <table>
      <tr><th colspan="2">基本條件</th></tr>
      <tr>
        <td>病患體重</td>
        <td>${weight} kg</td>
      </tr>
      <tr>
        <td>可用劑型</td>
        <td>${
          vialOption === '60' ? '僅 60 mg/vial' :
          vialOption === '30' ? '僅 30 mg/vial' : 
          '30 mg & 60 mg 均可'
        }</td>
      </tr>
      <tr>
        <td>維持期頻率</td>
        <td>${freqText}</td>
      </tr>
    </table>

    <table>
      <tr><th colspan="5">負荷期 (Loading)：前 4 週，每週 3 mg/kg</th></tr>
      <tr>
        <td>單次需求 (mg)</td>
        <td>總次數</td>
        <td>合計需求 (mg)</td>
        <td>負荷期合計 瓶數</td>
        <td>負荷期實際供給 (mg)</td>
      </tr>
      <tr>
        <td>${loadingDoseEach.toFixed(1)}</td>
        <td>${loadingTimes}</td>
        <td>${(loadingDoseEach*loadingTimes).toFixed(1)}</td>
        <td>${loadingTotalVials}</td>
        <td>${loadingTotalProvidedMg}</td>
      </tr>
    </table>

    <table>
      <tr><th colspan="5">維持期 (Maintenance)</th></tr>
      <tr>
        <td>單次需求 (mg)</td>
        <td>一年次數</td>
        <td>合計需求 (mg/年)</td>
        <td>維持期合計 瓶數</td>
        <td>維持期實際供給 (mg)</td>
      </tr>
      <tr>
        <td>${maintenanceDoseEach.toFixed(1)}</td>
        <td>${maintenanceTimes}</td>
        <td>${(maintenanceDoseEach*maintenanceTimes).toFixed(1)}</td>
        <td>${maintenanceTotalVials}</td>
        <td>${maintenanceTotalProvidedMg}</td>
      </tr>
    </table>

    <table>
      <tr><th colspan="4">一年合計</th></tr>
      <tr>
        <td>實際需求總量 (mg)</td>
        <td>實際供給總量 (mg)</td>
        <td>浪費量 (mg)</td>
        <td>總瓶數</td>
      </tr>
      <tr>
        <td>${realNeeded.toFixed(1)}</td>
        <td>${totalProvidedMg}</td>
        <td>${totalWasted}</td>
        <td>${totalVials}</td>
      </tr>
    </table>

    <div class="note">
      <strong>注意：</strong>此計算假設「每次開瓶後的剩餘藥量無法跨次再使用」。若有院內作業可共享部分未使用藥量，結果可能不同。
    </div>
  `;

  document.getElementById('resultText').innerHTML = html;
  document.getElementById('result').style.display = 'block';
}
</script>

</body>
</html>
